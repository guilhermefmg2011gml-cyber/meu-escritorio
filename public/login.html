<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entrar — Moura Martins Advogados</title>
<script src="/config.js"></script>
<style>
  :root {
    --bg: #24100F; --card:#2E1513; --gold:#c9a268; --text:#f5eee8; --muted:#cdbfb8;
    --radius: 14px;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px;}
  .card{width:min(420px,90vw);background:var(--card);border-radius:var(--radius);padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.45);}
  h1{margin:0 0 16px;font-weight:600;letter-spacing:.2px}
  label{display:block;margin:14px 0 6px;color:var(--muted);font-size:.92rem}
  input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #3b1f1c;background:#1d0d0c;color:var(--text)}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:14px}
  button{background:var(--gold);color:#24100F;border:0;padding:12px 16px;border-radius:999px;font-weight:600;cursor:pointer}
  .help{color:var(--muted);font-size:.9rem;margin-top:10px}
  .error{background:#5a1e1b;color:#ffdede;border:1px solid #b05757;padding:10px;border-radius:10px;margin-top:12px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Entrar</h1>
    <div class="error" id="err"></div>
    <label>E-mail</label>
    <input id="email" type="email" placeholder="seuemail@dominio.com.br" />
    <label>Senha</label>
    <input id="password" type="password" placeholder="Sua senha" />
    <div class="row">
      <span class="help">Esqueceu a senha? Peça ao administrador.</span>
      <button id="btnEntrar">Entrar</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = window.API_BASE;

const $ = (sel) => document.querySelector(sel);
  const btn = $("#btnEntrar");
  const emailInput = $("#email");
  const passInput = $("#password");
  const errBox = $("#err");

  function clearError() {
    errBox.textContent = "";
    errBox.style.display = "none";
  }

  async function doLogin() {
    clearError();
    btn.disabled = true;

    try {
      const email = emailInput.value.trim();
      const password = passInput.value;

      const resp = await fetch(`${API_BASE}/api/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      const data = await resp.json();
    
      if (!resp.ok) throw new Error(data.error || "Falha ao entrar");

      localStorage.setItem("mma_token", data.token);
      localStorage.setItem("mma_role", data.role || (data.user && data.user.role) || "user");

      if (data.isFirstLogin || (data.user && data.user.isFirstLogin)) {
        location.href = "/primeiro-acesso.html";
        return;
      }

      const role = localStorage.getItem("mma_role");
      const redirectMap = {
        admin: "/admin/create-user.html"
      };
      const targetPath = redirectMap[role] || "/";
      location.href = targetPath;
    } catch (e) {
      errBox.textContent = e.message;
      errBox.style.display = "block";
    } finally {
      btn.disabled = false;
    }
  }
  btn.addEventListener("click", doLogin);
  passInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") doLogin();
  });
</script>
</body>
</html>