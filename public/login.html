<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entrar — Moura Martins Advogados</title>
<style>
  :root {
    --bg: #24100F; --card:#2E1513; --gold:#c9a268; --text:#f5eee8; --muted:#cdbfb8;
    --radius: 14px;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px;}
  .card{width:min(420px,90vw);background:var(--card);border-radius:var(--radius);padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.45);}
  h1{margin:0 0 16px;font-weight:600;letter-spacing:.2px}
  label{display:block;margin:14px 0 6px;color:var(--muted);font-size:.92rem}
  input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #3b1f1c;background:#1d0d0c;color:var(--text)}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:14px}
  button{background:var(--gold);color:#24100F;border:0;padding:12px 16px;border-radius:999px;font-weight:600;cursor:pointer}
  .help{color:var(--muted);font-size:.9rem;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Entrar</h1>
    <form id="loginForm">
      <label for="email">E-mail</label>
      <input id="email" type="email" placeholder="seuemail@dominio.com.br" required />
      <label for="password">Senha</label>
      <input id="password" type="password" placeholder="Sua senha" required />
      <div class="row">
        <span class="help">Esqueceu a senha? Peça ao administrador.</span>
        <button type="submit">Entrar</button>
      </div>
      <div id="error" style="display:none;margin-top:12px;color:#ffb4b4;font-size:.9rem"></div>
    </form>
  </div>
</div>

<script type="module">
  import * as API from "/js/api-client.js";
  window.API = API;
</script>
<script>
  const form = document.getElementById('loginForm');
  const errorBox = document.getElementById('error');
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;

function showError(message) {
    errorBox.textContent = message;
    errorBox.style.display = 'block';
  }

  function clearError() {
    errorBox.textContent = '';
    errorBox.style.display = 'none';
  }

  async function checkSession() {
    if (!window.API) return;
    try {
      const { res, data } = await window.API.me();
      if (res.status === 200 && data && data.user) {
        window.location.replace('/admin/app.html');
      }
    } catch (err) {
      console.debug('[login] nenhuma sessão ativa', err);
    }
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    clearError();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Entrando...';

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    try {
      const { res, data } = await window.API.login({ email, password });
      if (res.status === 200) {
        window.location.href = '/admin/app.html';
        return;
      }

      const message = data?.error || data?.message || 'Falha ao entrar.';
      showError(message);
    } catch (error) {
      console.warn('[login] erro ao autenticar', error);
      showError('Erro ao autenticar. Tente novamente.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
  
  checkSession();
</script>
</body>
</html>