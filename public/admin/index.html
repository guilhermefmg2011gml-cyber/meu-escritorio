<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Painel — Moura Martins</title>
  <script src="/js/api-client.js"></script>
  <script src="/js/auth-guard.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;background:#110b0b;color:#f3e9e9}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .card{background:#201212;border-radius:12px;padding:16px;margin-bottom:16px}
    button{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="top">
    <h1>Painel do Administrador</h1>
    <button id="logout">Sair</button>
  </div>
  <div class="card">
    <h2>Usuários</h2>
    <ul id="users"></ul>
    <button id="goUsers">Gerenciar usuários</button>
  </div>
  <div class="card">
    <h2>Auditoria (últimos eventos)</h2>
    <ul id="audit"></ul>
    <a href="/admin/auditoria.html"><button>Ver auditoria</button></a>
  </div>

  <script>
    const logoutButton = document.getElementById('logout');
    if (logoutButton) {
      logoutButton.onclick = async () => {
        try {
          await window.API?.logout();
        } catch (err) {
          console.warn('[painel] falha ao sair', err);
        }
        window.location.href = '/login.html';
      };
    }

  (async function bootstrap() {
      if (!window.API) return;
      const ul = document.getElementById('users');
      try {
        const result = await window.API.adminUsers();
        if (!result || result.res.status !== 200) {
          console.warn('/api/admin/users retornou', result?.res?.status);
        ul.innerHTML = '<li>Falha ao carregar</li>';
        } else {
          const rows = Array.isArray(result.data) ? result.data.slice(0, 5) : [];
          usersEl.innerHTML = rows.map((u) => `<li>${u.email} — ${u.role}</li>`).join('');
          if (!usersEl.innerHTML) {
            usersEl.innerHTML = '<li>Nenhum usuário cadastrado</li>';
          }
        }
      } catch (e) {
        console.warn('Falha ao carregar usuários', e);
        usersEl.innerHTML = '<li>Falha ao carregar</li>';
      }

      const auditEl = document.getElementById('audit');
      try {
        const result = await window.API.auditLatest();
        if (!result || result.res.status !== 200) {
          console.warn('audit/latest retornou', result?.res?.status);
          auditEl.innerHTML = '<li>Falha ao carregar</li>';
        } else {
          const list = Array.isArray(result.data) ? result.data.slice(0, 5) : [];
          auditEl.innerHTML = list
            .map((r) => {
              const target = r.entity || r.target || '';
              const targetId = r.entity_id ? ` #${r.entity_id}` : '';
              return `<li>${r.created_at || r.ts || '—'} — ${r.user_email || r.user || 'admin'} — ${r.action || ''} ${target}${targetId}</li>`;
            })
            .join('');
          if (!auditEl.innerHTML) {
            auditEl.innerHTML = '<li>Sem registros de auditoria</li>';
          }
        }
      } catch (e) {
        console.warn('Falha ao carregar auditoria', e);
        auditEl.innerHTML = '<li>Falha ao carregar</li>';
      }

      const goUsers = document.getElementById('goUsers');
      if (goUsers) {
        goUsers.onclick = () => (window.location.href = '/admin/usuarios.html');
      }
    })();
  </script>
</body>
</html>