<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Painel — Moura Martins</title>
  <script src="/admin/auth-guard.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;background:#110b0b;color:#f3e9e9}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .card{background:#201212;border-radius:12px;padding:16px;margin-bottom:16px}
    button{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="top">
    <h1>Painel do Administrador</h1>
    <button id="logout">Sair</button>
  </div>
  <div class="card">
    <h2>Usuários</h2>
    <ul id="users"></ul>
    <button id="goUsers">Gerenciar usuários</button>
  </div>
  <div class="card">
    <h2>Auditoria (últimos eventos)</h2>
    <ul id="audit"></ul>
    <a href="/admin/auditoria.html"><button>Ver auditoria</button></a>
  </div>

  <script type="module">
    import { mmaApi } from './api.js';

  document.getElementById('logout').onclick = () => {
      localStorage.removeItem('mma_token');
      window.location.href = '/login.html';
    };

    (async function () {
      const ul = document.getElementById('users');
      try {
        const res = await mmaApi.get('/api/admin/users');
        const rows = await res.json();
        ul.innerHTML = rows.slice(0, 5).map((u) => `<li>${u.email} — ${u.role}</li>`).join('');
      } catch (e) {
        ul.innerHTML = '<li>Falha ao carregar</li>';
      }

      const logUl = document.getElementById('audit');
      try {
        const res = await mmaApi.get('/api/audit?limit=5');
        const rows = await res.json();
        logUl.innerHTML = rows
          .map((r) => `<li>${r.created_at} — ${r.user_email || 'admin'} — ${r.action} ${r.entity || ''}#${r.entity_id || ''}</li>`)
          .join('');
      } catch (e) {
        logUl.innerHTML = '<li>Falha ao carregar</li>';
      }

      document.getElementById('goUsers').onclick = () => (window.location.href = '/admin/usuarios.html');
    })();
  </script>
</body>
</html>