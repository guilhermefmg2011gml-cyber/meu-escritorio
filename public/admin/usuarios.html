<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Usuários — Moura Martins</title>
  <script type="module" src="/js/api-client.js"></script>
  <script type="module" src="/js/auth-guard.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;background:#110b0b;color:#f3e9e9}
    table{width:100%;border-collapse:collapse;background:#201212;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #3a2323}
    .top{display:flex;gap:8px;margin-bottom:16px}
    input,select,button{padding:8px;border-radius:8px;border:0}
    .row-actions button{margin-right:6px}
  </style>
</head>
<body>
  <div class="top">
    <button onclick="window.location.href='/admin/index.html'">← Voltar</button>
    <input id="email" placeholder="email@dominio.com.br" />
    <input id="password" placeholder="senha inicial" type="password"/>
    <select id="role">
      <option value="colab">colab</option>
      <option value="gestor">gestor</option>
      <option value="admin">admin</option>
    </select>
    <button id="btnCreate">Criar usuário</button>
  </div>

  <table>
    <thead>
      <tr><th>ID</th><th>Email</th><th>Papel</th><th>Ações</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
  (function () {
    if (!window.API) return;

    const tbody = document.getElementById('tbody');

    async function load() {
      try {
        const result = await window.API.adminUsers();
        if (!result || result.res.status !== 200 || !Array.isArray(result.data)) {
          console.warn('[usuarios] falha ao listar', result?.res?.status);
          tbody.innerHTML = '<tr><td colspan="4">Não foi possível carregar os usuários.</td></tr>';
          return;
        }

        tbody.innerHTML = result.data
          .map(
            (u) => `
        <tr>
          <td>${u.id}</td>
          <td>${u.email}</td>
          <td>
            <select data-id="${u.id}" class="sel-role">
              <option value="colab"  ${u.role === 'colab' ? 'selected' : ''}>colab</option>
              <option value="gestor" ${u.role === 'gestor' ? 'selected' : ''}>gestor</option>
              <option value="admin"  ${u.role === 'admin' ? 'selected' : ''}>admin</option>
            </select>
          </td>
          <td class="row-actions">
            <button data-id="${u.id}" class="btn-reset">Redefinir senha</button>
            <button data-id="${u.id}" class="btn-del">Excluir</button>
          </td>
        </tr>
      `
          )
          .join('');

        if (!tbody.innerHTML) {
          tbody.innerHTML = '<tr><td colspan="4">Nenhum usuário cadastrado.</td></tr>';
        }

        bindActions();
      } catch (err) {
        console.warn('[usuarios] erro ao carregar', err);
        tbody.innerHTML = '<tr><td colspan="4">Não foi possível carregar os usuários.</td></tr>';
      }
    }

    function bindActions() {
      document.querySelectorAll('.sel-role').forEach((el) => {
        el.onchange = async () => {
          const id = el.dataset.id;
          try {
            const result = await window.API.json(`/admin/users/${id}`, {
              method: 'PUT',
              body: { role: el.value },
            });
            if (!result.res.ok) {
              alert('Falha ao atualizar papel.');
            } else {
              alert('Papel atualizado.');
            }
          } catch (error) {
            console.warn('[usuarios] erro ao atualizar papel', error);
            alert('Falha ao atualizar papel.');
          }
        };
      });

      document.querySelectorAll('.btn-reset').forEach((button) => {
        button.onclick = async () => {
          const id = button.dataset.id;
          const password = prompt('Nova senha para o usuário:');
          if (!password) return;
          try {
            const result = await window.API.json(`/admin/users/${id}`, {
              method: 'PUT',
              body: { password },
            });
            if (!result.res.ok) {
              alert('Falha ao redefinir senha.');
            } else {
              alert('Senha atualizada.');
            }
          } catch (error) {
            console.warn('[usuarios] erro ao redefinir senha', error);
            alert('Falha ao redefinir senha.');
          }
        };
      });

      document.querySelectorAll('.btn-del').forEach((button) => {
        button.onclick = async () => {
          const id = button.dataset.id;
          if (!confirm('Excluir este usuário?')) return;
          try {
            const res = await window.API.request(`/admin/users/${id}`, { method: 'DELETE' });
            if (!res.ok) {
              alert('Falha ao excluir usuário.');
              return;
            }
            load();
          } catch (error) {
            console.warn('[usuarios] erro ao excluir', error);
            alert('Falha ao excluir usuário.');
          }
        };
      });
    }

    document.getElementById('btnCreate').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;
      if (!email || !password) {
        alert('Preencha email e senha.');
        return;
      }

      try {
        const result = await window.API.json('/admin/users', {
          method: 'POST',
          body: { email, password, role },
        });

        if (!result.res.ok) {
          const message = result.data?.error || 'Erro ao criar (email pode estar em uso).';
          alert(message);
          return;
        }

        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        load();
      } catch (error) {
        console.warn('[usuarios] erro ao criar', error);
        alert('Erro ao criar usuário.');
      }
    };

    load();
   })();
  </script>
</body>
</html>