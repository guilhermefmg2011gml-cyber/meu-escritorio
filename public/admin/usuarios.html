<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Usuários — Moura Martins</title>
  <script src="/admin/auth-guard.js"></script>
  <script src="/admin/api.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;background:#110b0b;color:#f3e9e9}
    table{width:100%;border-collapse:collapse;background:#201212;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #3a2323}
    .top{display:flex;gap:8px;margin-bottom:16px}
    input,select,button{padding:8px;border-radius:8px;border:0}
    .row-actions button{margin-right:6px}
  </style>
</head>
<body>
  <div class="top">
    <button onclick="window.location.href='/admin/index.html'">← Voltar</button>
    <input id="email" placeholder="email@dominio.com.br" />
    <input id="password" placeholder="senha inicial" type="password"/>
    <select id="role">
      <option value="colab">colab</option>
      <option value="gestor">gestor</option>
      <option value="admin">admin</option>
    </select>
    <button id="btnCreate">Criar usuário</button>
  </div>

  <table>
    <thead>
      <tr><th>ID</th><th>Email</th><th>Papel</th><th>Ações</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
  async function load() {
    const res = await mmaApi.get("/api/admin/users");
    const rows = await res.json();
    const tb = document.getElementById("tbody");
    tb.innerHTML = rows.map(u => `
      <tr>
        <td>${u.id}</td>
        <td>${u.email}</td>
        <td>
          <select data-id="${u.id}" class="sel-role">
            <option value="colab"  ${u.role==="colab"?"selected":""}>colab</option>
            <option value="gestor" ${u.role==="gestor"?"selected":""}>gestor</option>
            <option value="admin"  ${u.role==="admin"?"selected":""}>admin</option>
          </select>
        </td>
        <td class="row-actions">
          <button data-id="${u.id}" class="btn-reset">Redefinir senha</button>
          <button data-id="${u.id}" class="btn-del">Excluir</button>
        </td>
      </tr>
    `).join("");

    document.querySelectorAll(".sel-role").forEach(el=>{
      el.onchange = async () => {
        const id = el.dataset.id;
        await mmaApi.put(`/api/admin/users/${id}`, { role: el.value });
        alert("Papel atualizado.");
      };
    });

    document.querySelectorAll(".btn-reset").forEach(b=>{
      b.onclick = async () => {
        const id = b.dataset.id;
        const p = prompt("Nova senha para o usuário:");
        if (!p) return;
        await mmaApi.put(`/api/admin/users/${id}`, { password: p });
        alert("Senha atualizada.");
      };
    });

    document.querySelectorAll(".btn-del").forEach(b=>{
      b.onclick = async () => {
        const id = b.dataset.id;
        if (!confirm("Excluir este usuário?")) return;
        await mmaApi.del(`/api/admin/users/${id}`);
        load();
      };
    });
  }

  document.getElementById("btnCreate").onclick = async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const role = document.getElementById("role").value;
    if (!email || !password) { alert("Preencha email e senha."); return; }
    const res = await mmaApi.post("/api/admin/users", { email, password, role });
    if (!res.ok) { alert("Erro ao criar (email pode estar em uso)."); return; }
    document.getElementById("email").value="";
    document.getElementById("password").value="";
    load();
  };

  load();
  </script>
</body>
</html>