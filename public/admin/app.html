<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Área de Trabalho — Moura Martins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="/config.js"></script>
  <script type="module" src="/js/api-client.js"></script>
  <script type="module" src="/js/auth-guard.js"></script>
  <link rel="stylesheet" href="/admin/app.css"/>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <iframe
      src="/admin/sidebar.html"
      title="Menu administrativo"
      class="sidebar-frame"
    ></iframe>
  </aside>

  <!-- TOPBAR -->
  <header class="topbar">
    <button class="btn-secondary menu" data-menu>☰</button>
    <div class="crumb">Área de Trabalho</div>
    <div class="actions">
      <span class="badge">Admin</span>
      <button class="btn-secondary" onclick="location.href='/admin/usuarios.html'">Gerenciar usuários</button>
      <button data-logout>Sair</button>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="content">
    <div class="grid">

      <section class="card span-4">
        <h3>Usuários</h3>
        <div class="muted">Total de contas</div>
        <div style="font-size:36px; font-weight:800; margin-top:8px" id="kpi-usuarios">—</div>
      </section>

      <section class="card span-4">
        <h3>Eventos do sistema</h3>
        <div class="muted">Status de auditoria</div>
        <div style="font-size:36px; font-weight:800; margin-top:8px" id="kpi-eventos">—</div>
      </section>

      <section class="card span-4">
        <h3>Acessos rápidos</h3>
        <div class="muted">Atalhos do dia a dia</div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <a class="btn" href="/admin/agenda.html">Abrir Agenda</a>
          <a class="btn" href="/admin/contatos.html">Ver Contatos</a>
          <a class="btn" href="/admin/atendimentos.html">Atendimentos</a>
        </div>
      </section>

      <section class="card span-8">
        <h3>Gerador de Peças Inteligentes</h3>
        <div class="muted">Crie rascunhos estratégicos com base em modelos inteligentes.</div>
        <div class="generator-status" id="generator-status">Inicializando...</div>
        <div class="generator-actions">
          <button class="btn" id="generator-run">Gerar peça de exemplo</button>
        </div>
        <pre class="generator-preview muted" id="generator-preview">Nenhuma peça gerada até o momento.</pre>
      </section>

      <section class="card span-8">
        <h3>Últimas ações (auditoria)</h3>
        <table class="table" id="audit-table">
          <thead><tr><th>Quando</th><th>Usuário</th><th>Ação</th><th>Alvo</th></tr></thead>
          <tbody></tbody>
        </table>
         <script>
          (async function loadAuditTable() {
            const tbody = document.querySelector('#audit-table tbody');
            if (!tbody || !window.API) return;

            try {
              const result = await window.API.auditLatest();
              if (!result || result.res.status !== 200) {
                console.warn('audit/latest retornou', result?.res?.status);
                tbody.innerHTML = '';
                return;
              }

              const rows = Array.isArray(result.data) ? result.data.slice(0, 8) : [];
              tbody.innerHTML = rows

                .map(
                  (r) => `
                <tr>
                  <td>${r.created_at || r.ts || '-'}</td>
                  <td>${r.user_email || r.user || 'admin'}</td>
                  <td>${r.action || '-'}</td>
                  <td>${(r.entity || r.target || '-')}${r.entity_id ? ` #${r.entity_id}` : ''}</td>
                </tr>`
                )
                .join('');
            } catch (error) {
              console.warn('Falha ao carregar auditoria recente', error);
              tbody.innerHTML = '';
            }
          })();
        </script>
      </section>

      <section class="card span-4">
        <h3>Lembretes rápidos</h3>
        <ul style="margin:8px 0 0 16px">
          <li>Definir papéis de novos colaboradores</li>
          <li>Conferir agenda da semana</li>
          <li>Revisar atendimentos pendentes</li>
        </ul>
      </section>

    </div>
  </main>
</div>

<script type="module" src="/admin/app.js"></script>
</body>
</html>