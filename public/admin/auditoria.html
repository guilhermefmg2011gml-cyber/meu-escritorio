<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Auditoria — Moura Martins</title>
  <script type="module" src="/js/api-client.js"></script>
  <script type="module" src="/js/auth-guard.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;background:#110b0b;color:#f3e9e9}
    .top{display:flex;gap:8px;margin-bottom:16px}
    input,button{padding:8px;border-radius:8px;border:0}
    .log{background:#201212;border-radius:12px;padding:12px;margin-bottom:8px}
    .muted{opacity:.7}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="top">
    <button onclick="window.location.href='/admin/index.html'">← Voltar</button>
    <input id="q" placeholder="filtrar por ação/entidade/email" />
    <button id="btn">Buscar</button>
  </div>

  <div id="list"></div>

  <script>
  (function () {
    if (!window.API) return;

    const root = document.getElementById('list');
    const input = document.getElementById('q');
    const button = document.getElementById('btn');

    async function load(query = '') {
      try {
        const result = await window.API.json(`/audit?limit=50&q=${encodeURIComponent(query)}`);
        if (!result || !result.res.ok || !Array.isArray(result.data)) {
          console.warn('/api/audit retornou', result?.res?.status);
          root.innerHTML = '<div class="log">Falha ao carregar registros.</div>';
          return;
        }

        root.innerHTML = result.data
          .map(
            (r) => `
        <div class="log">
          <div><strong>${r.action}</strong> — ${r.entity || '-'} #${r.entity_id || '-'}</div>
          <div class="muted">${r.created_at || r.ts || '—'} · ${r.user_email || r.user || 'admin'} · IP ${r.ip || '-'}</div>
          ${r.diff_json ? `<pre>${r.diff_json}</pre>` : r.meta ? `<pre>${r.meta}</pre>` : ''}
        </div>
      `
          )
          .join('');

        if (!root.innerHTML) {
          root.innerHTML = '<div class="log">Nenhum registro encontrado.</div>';
        }
      } catch (error) {
        console.warn('Falha ao carregar auditoria', error);
        root.innerHTML = '<div class="log">Falha ao carregar registros.</div>';
      }
    }
 button.onclick = () => load(input.value);
    load();
  })();
  </script>
</body>
</html>