<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Novo Processo — Moura Martins</title>
  <link rel="stylesheet" href="/admin/app.css" />
  <script src="/config.js"></script>
  <script type="module" src="/js/api-client.js"></script>
  <script type="module" src="/js/auth-guard.js"></script>
</head>
<body class="dark">
  <div class="container">
    <h1>Novo processo</h1>
    <form id="f">
      <div class="grid">
        <label>Nº CNJ
          <input name="cnj_number" placeholder="0000000-00.0000.0.00.0000" required>
        </label>
        <label>Tribunal/Órgão
          <input name="court" placeholder="TJGO">
        </label>
        <label>Jurisd./Instância
          <input name="jurisdiction" placeholder="Estadual / 1ª instância">
        </label>
        <label>Área
          <input name="area" placeholder="Cível / Criminal / ...">
        </label>
        <label>Assunto
          <input name="subject" placeholder="Assunto principal">
        </label>
        <label>Situação
          <input name="situation" value="Em andamento">
        </label>
        <label>Status (rótulo)
          <input name="status" value="ativo">
        </label>
      </div>

      <h3>Partes (opcional)</h3>
      <div id="parties"></div>
      <button type="button" id="addParty" class="btn">+ Adicionar parte</button>

      <div class="actions">
        <a class="btn" href="/admin/processos.html">Cancelar</a>
        <button class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </div>

  <script type="module">
    import { api } from "/js/api-client.js";
    import "/js/auth-guard.js";

    const $f = document.querySelector("#f");
    const $parties = document.querySelector("#parties");
    const $add = document.querySelector("#addParty");

    function partyRow() {
      const wrap = document.createElement("div");
      wrap.className = "grid party";
      wrap.innerHTML = `
        <label>Papel <input name="role" placeholder="AUTOR / RÉU / ADVOGADO"></label>
        <label>Nome <input name="name" placeholder="Nome completo"></label>
        <label>Documento <input name="doc" placeholder="CPF/CNPJ"></label>
        <label>OAB <input name="oab" placeholder="UF-numero (ex.: GO-76350)"></label>
        <button type="button" class="btn btn-danger remove">Remover</button>
      `;
      wrap.querySelector(".remove").onclick = () => wrap.remove();
      return wrap;
    }

    $add.onclick = () => $parties.appendChild(partyRow());

    $f.onsubmit = async (e) => {
      e.preventDefault();
      const form = new FormData($f);
      const payload = {
        cnj_number: form.get("cnj_number"),
        court: form.get("court"),
        jurisdiction: form.get("jurisdiction"),
        area: form.get("area"),
        subject: form.get("subject"),
        situation: form.get("situation"),
        status: form.get("status"),
        parties: [...$parties.querySelectorAll(".party")].map((p) => ({
          role: p.querySelector('[name="role"]').value || null,
          name: p.querySelector('[name="name"]').value || null,
          doc: p.querySelector('[name="doc"]').value || null,
          oab: p.querySelector('[name="oab"]').value || null,
        })),
      };

      try {
        const { id } = await api.post("/processes/manual", payload);
        window.location.href = `/admin/processo.html?id=${id}`;
      } catch (err) {
        alert("Não foi possível salvar. Verifique o CNJ e tente novamente.");
        console.error(err);
      }
    };
  </script>
</body>
</html>