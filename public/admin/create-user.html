<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Criar usuário</title>
<script src="/config.js"></script>
<style>
  body{font-family:Inter,system-ui;margin:0;background:#24100F;color:#f5eee8}
  header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;background:#2E1513}
  a{color:#c9a268;text-decoration:none;font-weight:600}
  .wrap{max-width:960px;margin:28px auto;padding:0 16px}
  .card{background:#2E1513;border-radius:14px;padding:24px}
  form label{display:block;margin:12px 0 6px;color:#cdbfb8}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #3b1f1c;background:#1d0d0c;color:#f5eee8}
  button{margin-top:16px;background:#c9a268;color:#24100F;border:0;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
  .field-group{margin-top:14px}
  .perm-grid{display:grid;grid-template-columns:repeat(2,minmax(180px,1fr));gap:10px}
  .switch{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
  .switch input{accent-color:#d7b57a;width:18px;height:18px}
  .switch span{color:#efe5dd}
  .alert{margin-top:12px}
</style>
</head>
<body>
<header>
  <strong>Painel do Administrador</strong>
  <nav>
    <a href="/alterar-senha.html">Alterar senha</a> &nbsp;|&nbsp;
    <a id="logout" href="#">Sair</a>
  </nav>
</header>
<div class="wrap">
  <div class="card">
    <h2>Criar novo usuário</h2>
    <form id="create-form">
      <div class="alert" id="alert"></div>
      <label for="email">E-mail do usuário</label>
      <input id="email" name="email" type="email" required />
      <label for="password">Senha provisória</label>
      <input id="password" name="password" type="text" placeholder="Min. 8 caracteres" required />

      <div class="field-group">
        <label style="display:block;margin:0 0 6px;color:#cdb9a6">Permissões do colaborador</label>
        <div class="perm-grid">
          <label class="switch"><input type="checkbox" id="perm-processos" checked><span>Processos e casos</span></label>
          <label class="switch"><input type="checkbox" id="perm-atendimentos" checked><span>Atendimentos</span></label>
          <label class="switch"><input type="checkbox" id="perm-financeiro"><span>Financeiro</span></label>
          <label class="switch"><input type="checkbox" id="perm-pecas" checked><span>Criação de peças</span></label>
          <label class="switch"><input type="checkbox" id="perm-docs"><span>Documentos</span></label>
        </div>
      </div>

      <button type="submit" id="btnCriar">Criar usuário</button>
    </form>
  </div>
</div>
<script>
const API_BASE = (window.API_BASE || '/api').replace(/\/+$/, '');
const apiUrl = (path) => `${API_BASE}${path.startsWith('/') ? path : `/${path}`}`;
  const token = localStorage.getItem('mma_token');
  const role = localStorage.getItem('mma_role');

  if (!token || role !== 'admin') {
    location.href = '/login.html';
  }

  const form = document.getElementById('create-form');
  const alertBox = document.getElementById('alert');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    alertBox.textContent = '';
    alertBox.style.color = '';

    const email = document.getElementById('email').value.trim();
    const pwd = document.getElementById('password').value;

    if (!email || pwd.length < 8) {
      alertBox.style.color = '#ffdede';
      alertBox.textContent = 'Informe um e-mail válido e senha com pelo menos 8 caracteres.';
      return;
    }

    const permissions = {
      processos:     document.getElementById('perm-processos').checked,
      atendimentos:  document.getElementById('perm-atendimentos').checked,
      financeiro:    document.getElementById('perm-financeiro').checked,
      pecas:         document.getElementById('perm-pecas').checked,
      docs:          document.getElementById('perm-docs').checked,
    };

    try {
      const resp = await fetch(apiUrl('/admin/users'), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ email, password: pwd, permissions })
      });
      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        throw new Error(data.error || 'Erro ao criar usuário');
      }

      alert('Usuário criado com sucesso!');
      location.href = '/admin/usuarios.html';
    } catch (err) {
      alertBox.style.color = '#ffdede';
      alertBox.textContent = err.message;
    }
  });

  const logout = document.getElementById('logout');
  if (logout) {
    logout.addEventListener('click', () => {
      localStorage.removeItem('mma_token');
      localStorage.removeItem('mma_role');
      localStorage.removeItem('mma_permissions');
      localStorage.removeItem('mma_user');
      location.href = '/login.html';
    });
  }
</script>
</body>
</html>